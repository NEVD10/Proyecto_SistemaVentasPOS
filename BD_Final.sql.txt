CREATE DATABASE SistemaVentasS;
GO

USE SistemaVentasS;
GO

-- Tabla Cliente
CREATE TABLE Cliente (
    IdCliente INT PRIMARY KEY IDENTITY(1,1),
    TipoDocumento VARCHAR(20) NOT NULL,  -- DNI/RUC/Carnet Extranjería
    NumeroDocumento VARCHAR(12) UNIQUE NOT NULL,
    Nombres VARCHAR(30) NOT NULL,
    Apellidos VARCHAR(60),
    Telefono VARCHAR(9),
    Email VARCHAR(100),
    Direccion VARCHAR(100),
    FechaRegistro DATETIME DEFAULT GETDATE()
);
GO

-- Tabla Usuario
CREATE TABLE Usuario (
    IdUsuario INT PRIMARY KEY IDENTITY(1,1),
    NombreUsuario VARCHAR(20) UNIQUE NOT NULL,
    PasswordHash VARCHAR(255) NOT NULL,
    NombreCompleto VARCHAR(100) NOT NULL,
    Rol VARCHAR(15) NOT NULL CHECK (Rol IN ('Administrador', 'Vendedor', 'Almacen')),
    Email VARCHAR(100),
    Estado BIT DEFAULT 1
);
GO

-- Primero crear la tabla Categoria (se necesita antes de Producto)
CREATE TABLE Categoria (
    IdCategoria INT PRIMARY KEY IDENTITY(1,1),
    Nombre VARCHAR(30) NOT NULL
);
GO

-- Tabla Producto (corregida la definición de IdCategoria)
CREATE TABLE Producto (
    IdProducto INT PRIMARY KEY IDENTITY(1,1),
    IdCategoria INT,  -- Corregido: se quitó el punto y coma
    Nombre VARCHAR(100) NOT NULL,
    CodigoBarras VARCHAR(50) UNIQUE,
    PrecioCosto DECIMAL(10, 2) NOT NULL,
    PrecioVenta DECIMAL(10, 2) NOT NULL,
    Stock INT NOT NULL DEFAULT 0,
    Marca VARCHAR(30),
    Estado BIT DEFAULT 1,
    FOREIGN KEY (IdCategoria) REFERENCES Categoria(IdCategoria),  -- Agregada la FK
    CHECK (PrecioVenta > PrecioCosto),
    CHECK (Stock >= 0)
);
GO

-- Tabla Venta (corregido el DEFAULT para MetodoPago)
CREATE TABLE Venta (
    IdVenta INT PRIMARY KEY IDENTITY(1,1),
    FechaVenta DATETIME DEFAULT GETDATE(),
    TipoComprobante VARCHAR(20) NOT NULL,  -- Boleta/Factura (quitada coma extra)
    NumeroComprobante VARCHAR(20),
    Subtotal DECIMAL(10, 2) NOT NULL,
    MontoIGV DECIMAL(10, 2) NOT NULL DEFAULT 0,  -- 18% en Perú, por ejemplo
    MontoTotal DECIMAL(10, 2) NOT NULL,
    MetodoPago VARCHAR(20) NOT NULL DEFAULT 'Efectivo',  -- Efectivo/Tarjeta/Yape/Transferencia
    IdCliente INT,
    IdUsuario INT NOT NULL,
    FOREIGN KEY (IdCliente) REFERENCES Cliente(IdCliente),
    FOREIGN KEY (IdUsuario) REFERENCES Usuario(IdUsuario)
);
GO

-- Tabla DetalleVenta (versión optimizada)
CREATE TABLE DetalleVenta (
    IdDetalleVenta INT PRIMARY KEY IDENTITY(1,1),
    IdVenta INT NOT NULL,
    IdProducto INT NOT NULL,
    Cantidad INT NOT NULL CHECK (Cantidad > 0),
    PrecioUnitario DECIMAL(10, 2) NOT NULL,
    SubtotalLinea DECIMAL(10, 2) NOT NULL,  -- Cantidad * PrecioUnitario
    FOREIGN KEY (IdVenta) REFERENCES Venta(IdVenta) ON DELETE CASCADE,
    FOREIGN KEY (IdProducto) REFERENCES Producto(IdProducto)
);
GO

-- Índices para mejorar rendimiento
CREATE INDEX IX_Cliente_Documento ON Cliente(NumeroDocumento);
CREATE INDEX IX_Producto_CodigoBarras ON Producto(CodigoBarras);
CREATE INDEX IX_Venta_Fecha ON Venta(FechaVenta);
CREATE INDEX IX_DetalleVenta_Venta ON DetalleVenta(IdVenta);
GO